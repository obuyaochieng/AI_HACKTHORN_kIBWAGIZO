{% extends 'base.html' %}
{% load static %}

{% block title %}Farm Map - Machakos AIDSTTUP{% endblock %}

{% block extra_css %}
<style>
    .map-container {
        position: relative;
    }
    
    .map-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: 300px;
    }
    
    .farm-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .farm-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .farm-item:hover {
        background-color: #f8f9fa;
    }
    
    .farm-item.active {
        background-color: #e8f4fd;
        border-left: 4px solid var(--primary-color);
    }
    
    .index-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .layer-control {
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">
            <i class="fas fa-map-marked-alt text-primary me-2"></i>
            Machakos County Farm Monitoring Map
        </h1>
        <p class="text-muted mb-0">
            Monitor farm conditions using satellite imagery and drought indices
        </p>
    </div>
</div>

<div class="row">
    <!-- Map Controls -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-filter me-2"></i> Filter Farms
            </div>
            <div class="card-body">
                <!-- Risk Filter -->
                <div class="mb-3">
                    <label class="form-label">Risk Level</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="risk-filter" id="risk-all" autocomplete="off" checked>
                        <label class="btn btn-outline-secondary" for="risk-all">All</label>
                        
                        <input type="radio" class="btn-check" name="risk-filter" id="risk-low" autocomplete="off">
                        <label class="btn btn-outline-success" for="risk-low">Low</label>
                        
                        <input type="radio" class="btn-check" name="risk-filter" id="risk-moderate" autocomplete="off">
                        <label class="btn btn-outline-warning" for="risk-moderate">Moderate</label>
                        
                        <input type="radio" class="btn-check" name="risk-filter" id="risk-severe" autocomplete="off">
                        <label class="btn btn-outline-danger" for="risk-severe">Severe</label>
                    </div>
                </div>
                
                <!-- Crop Filter -->
                <div class="mb-3">
                    <label class="form-label">Crop Type</label>
                    <select class="form-select" id="crop-filter">
                        <option value="all">All Crops</option>
                        <option value="maize" selected>Maize</option>
                        <option value="beans">Beans</option>
                        <option value="coffee">Coffee</option>
                        <option value="vegetables">Vegetables</option>
                    </select>
                </div>
                
                <!-- Subcounty Filter -->
                <div class="mb-3">
                    <label class="form-label">Subcounty</label>
                    <select class="form-select" id="subcounty-filter">
                        <option value="all">All Subcounties</option>
                        {% for subcounty in county.subcounties.all|slice:":10" %}
                        <option value="{{ subcounty.id }}">{{ subcounty.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Area Range -->
                <div class="mb-3">
                    <label class="form-label">Farm Size (hectares)</label>
                    <div class="d-flex justify-content-between">
                        <span id="area-min">0</span>
                        <span id="area-max">50+</span>
                    </div>
                    <input type="range" class="form-range" id="area-range" min="0" max="50" value="50">
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="analyzeSelectedFarms()">
                        <i class="fas fa-satellite me-2"></i> Analyze Selected
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSelection()">
                        <i class="fas fa-times me-2"></i> Clear Selection
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-key me-2"></i> Map Legend
            </div>
            <div class="card-body">
                <div class="legend-item d-flex align-items-center mb-2">
                    <div class="index-indicator" style="background-color: #28a745;"></div>
                    <span>Low Risk (NDVI > 0.4)</span>
                </div>
                <div class="legend-item d-flex align-items-center mb-2">
                    <div class="index-indicator" style="background-color: #ffc107;"></div>
                    <span>Moderate Risk (NDVI 0.3-0.4)</span>
                </div>
                <div class="legend-item d-flex align-items-center mb-2">
                    <div class="index-indicator" style="background-color: #dc3545;"></div>
                    <span>Severe Risk (NDVI < 0.3)</span>
                </div>
                <div class="legend-item d-flex align-items-center mb-2">
                    <div class="index-indicator" style="background-color: #6c757d;"></div>
                    <span>No Data Available</span>
                </div>
                
                <hr>
                
                <div class="mt-3">
                    <small class="text-muted d-block">Farm Icons:</small>
                    <div class="d-flex gap-2 mt-2">
                        <div class="farm-marker" style="background-color: #28a745;">M</div>
                        <small>Maize Farm</small>
                    </div>
                    <div class="d-flex gap-2 mt-1">
                        <div class="farm-marker" style="background-color: #17a2b8;">B</div>
                        <small>Beans Farm</small>
                    </div>
                    <div class="d-flex gap-2 mt-1">
                        <div class="farm-marker" style="background-color: #6f42c1;">C</div>
                        <small>Coffee Farm</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map Area -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-globe-africa me-2"></i>
                    Interactive Farm Map
                    <span class="badge bg-primary ms-2" id="farm-count">{{ total_farms }} Farms</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="zoomToMachakos()">
                        <i class="fas fa-search-location"></i> Zoom to Machakos
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleSatellite()">
                        <i class="fas fa-satellite"></i> Satellite View
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="map-container">
                    <div id="map"></div>
                    
                    <!-- Layer Controls -->
                    <div class="layer-control" style="position: absolute; bottom: 20px; right: 20px;">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggle-farms" checked>
                            <label class="form-check-label" for="toggle-farms">Show Farms</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggle-boundaries" checked>
                            <label class="form-check-label" for="toggle-boundaries">Show Boundaries</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggle-ndvi">
                            <label class="form-check-label" for="toggle-ndvi">Show NDVI Layer</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Selected Farm Details -->
        <div class="card mt-4" id="farm-details-card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle me-2"></i>
                    Selected Farm Details
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="closeFarmDetails()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body" id="farm-details-content">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Farm List Modal -->
<div class="modal fade" id="farmListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Farm List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="farm-table">
                        <thead>
                            <tr>
                                <th>Farm ID</th>
                                <th>Name</th>
                                <th>Farmer</th>
                                <th>Crop</th>
                                <th>Area (ha)</th>
                                <th>Risk Level</th>
                                <th>Last Analysis</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for farm in farms|slice:":50" %}
                            <tr data-farm-id="{{ farm.farm_id }}">
                                <td>{{ farm.farm_id }}</td>
                                <td>{{ farm.name|default:"Unnamed" }}</td>
                                <td>{{ farm.farmer.full_name|default:"Unknown" }}</td>
                                <td>
                                    <span class="badge bg-info">{{ farm.crop_type|default:"Unknown" }}</span>
                                </td>
                                <td>{{ farm.area_ha|floatformat:2 }}</td>
                                <td>
                                    {% with farm.analyses.first as latest %}
                                    {% if latest %}
                                        <span class="risk-badge risk-{{ latest.drought_risk_level }}">
                                            {{ latest.drought_risk_level|title }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">No Data</span>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with farm.analyses.first as latest %}
                                    {% if latest %}
                                        {{ latest.analysis_date|date:"Y-m-d" }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewFarm('{{ farm.farm_id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="analyzeFarm('{{ farm.farm_id }}')">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportFarmList()">
                    <i class="fas fa-download me-2"></i> Export to CSV
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    let map;
    let farmMarkers = {};
    let countyBoundary;
    let ndviLayer;
    let selectedFarms = new Set();
    
    // Colors for different risk levels
    const riskColors = {
        'low': '#28a745',
        'moderate': '#ffc107',
        'severe': '#dc3545',
        'unknown': '#6c757d'
    };
    
    // Crop type colors
    const cropColors = {
        'maize': '#28a745',
        'beans': '#17a2b8',
        'coffee': '#6f42c1',
        'vegetables': '#fd7e14',
        'default': '#6c757d'
    };
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        loadFarms();
        checkGEEStatus();
    });
    
    function initMap() {
        // Center on Machakos County
        const machakosCenter = [-1.5167, 37.2667]; // Latitude, Longitude
        
        map = L.map('map').setView(machakosCenter, 10);
        
        // Add base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri, Maxar, Earthstar Geographics'
        });
        
        // Add layer control
        const baseLayers = {
            "OpenStreetMap": osmLayer,
            "Satellite": satelliteLayer
        };
        
        L.control.layers(baseLayers).addTo(map);
        
        // Add scale control
        L.control.scale().addTo(map);
    }
    
    function loadFarms() {
        const farmData = {{ farm_data_json|safe }};
        
        // Clear existing markers
        Object.values(farmMarkers).forEach(marker => map.removeLayer(marker));
        farmMarkers = {};
        
        // Create markers for each farm
        farmData.forEach(farm => {
            if (farm.centroid) {
                const riskLevel = farm.risk_level || 'unknown';
                const cropType = farm.crop || 'default';
                
                // Create custom marker
                const markerIcon = L.divIcon({
                    className: 'farm-marker-icon',
                    html: `<div class="farm-marker" style="background-color: ${riskColors[riskLevel]};">${cropType.charAt(0).toUpperCase()}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const marker = L.marker([farm.centroid.lat, farm.centroid.lng], {
                    icon: markerIcon
                }).addTo(map);
                
                // Add popup
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h6 class="mb-2">${farm.name || 'Unnamed Farm'}</h6>
                        <p class="mb-1"><strong>Farm ID:</strong> ${farm.farm_id}</p>
                        <p class="mb-1"><strong>Farmer:</strong> ${farm.farmer}</p>
                        <p class="mb-1"><strong>Crop:</strong> ${farm.crop}</p>
                        <p class="mb-1"><strong>Area:</strong> ${farm.area_ha} ha</p>
                        <p class="mb-1"><strong>Risk Level:</strong> 
                            <span class="badge ${getRiskBadgeClass(farm.risk_level)}">
                                ${farm.risk_level || 'Unknown'}
                            </span>
                        </p>
                        ${farm.ndvi ? `<p class="mb-2"><strong>NDVI:</strong> ${farm.ndvi.toFixed(3)}</p>` : ''}
                        <div class="d-grid gap-1 mt-2">
                            <button class="btn btn-sm btn-primary" onclick="viewFarmDetails('${farm.farm_id}')">
                                View Details
                            </button>
                            <button class="btn btn-sm btn-success" onclick="analyzeFarm('${farm.farm_id}')">
                                Analyze
                            </button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                // Add click handler
                marker.on('click', function() {
                    viewFarmDetails(farm.farm_id);
                });
                
                // Store marker reference
                farmMarkers[farm.farm_id] = marker;
            }
        });
        
        // Fit bounds to show all farms
        if (farmData.length > 0) {
            const bounds = L.latLngBounds(
                farmData.map(f => [f.centroid.lat, f.centroid.lng])
            );
            map.fitBounds(bounds.pad(0.1));
        }
        
        updateFarmCount(farmData.length);
    }
    
    function getRiskBadgeClass(riskLevel) {
        switch(riskLevel) {
            case 'low': return 'bg-success';
            case 'moderate': return 'bg-warning';
            case 'severe': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function viewFarmDetails(farmId) {
        showLoading('Loading farm details...');
        
        fetch(`/farms/api/analysis/${farmId}/`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                displayFarmDetails(data);
                highlightFarm(farmId);
            })
            .catch(error => {
                hideLoading();
                showToast('Error loading farm details', 'danger');
                console.error('Error:', error);
            });
    }
    
    function displayFarmDetails(farmData) {
        const card = document.getElementById('farm-details-card');
        const content = document.getElementById('farm-details-content');
        
        const farm = farmData.farm;
        const analyses = farmData.analyses;
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h5>${farm.name || 'Unnamed Farm'}</h5>
                    <table class="table table-sm">
                        <tr><td><strong>Farm ID:</strong></td><td>${farm.id}</td></tr>
                        <tr><td><strong>Farmer:</strong></td><td>${farm.farmer}</td></tr>
                        <tr><td><strong>Crop Type:</strong></td><td>${farm.crop}</td></tr>
                        <tr><td><strong>Area:</strong></td><td>${farm.area_ha} hectares</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Latest Analysis</h6>
        `;
        
        if (analyses.length > 0) {
            const latest = analyses[0];
            html += `
                <div class="alert ${latest.risk_level === 'severe' ? 'alert-danger' : latest.risk_level === 'moderate' ? 'alert-warning' : 'alert-success'}">
                    <div class="d-flex justify-content-between">
                        <span><strong>Risk Level:</strong> ${latest.risk_level.toUpperCase()}</span>
                        <span>${latest.date}</span>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col">
                            <div class="index-value">${latest.ndvi ? latest.ndvi.toFixed(3) : 'N/A'}</div>
                            <small>NDVI</small>
                        </div>
                        <div class="col">
                            <div class="index-value">${latest.rainfall_mm ? latest.rainfall_mm.toFixed(1) : 'N/A'}</div>
                            <small>Rainfall (mm)</small>
                        </div>
                        <div class="col">
                            <div class="index-value">${latest.insurance_triggered ? 'Yes' : 'No'}</div>
                            <small>Insurance Trigger</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
            
            <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Analysis History</h6>
                    <button class="btn btn-sm btn-primary" onclick="showFarmChart('${farm.id}')">
                        <i class="fas fa-chart-line me-1"></i> View Charts
                    </button>
                </div>
        `;
        
        if (analyses.length > 0) {
            html += `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>NDVI</th>
                                <th>NDMI</th>
                                <th>Rainfall</th>
                                <th>Risk</th>
                                <th>Insurance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            analyses.slice(0, 10).forEach(analysis => {
                html += `
                    <tr>
                        <td>${analysis.date}</td>
                        <td>${analysis.ndvi ? analysis.ndvi.toFixed(3) : 'N/A'}</td>
                        <td>${analysis.ndmi ? analysis.ndmi.toFixed(3) : 'N/A'}</td>
                        <td>${analysis.rainfall_mm ? analysis.rainfall_mm.toFixed(1) + ' mm' : 'N/A'}</td>
                        <td><span class="badge ${getRiskBadgeClass(analysis.risk_level)}">${analysis.risk_level}</span></td>
                        <td>${analysis.insurance_triggered ? 
                            '<span class="badge bg-danger">Triggered</span>' : 
                            '<span class="badge bg-success">Normal</span>'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No analysis data available for this farm.
                    <button class="btn btn-sm btn-primary ms-2" onclick="analyzeFarm('${farm.id}')">
                        Run First Analysis
                    </button>
                </div>
            `;
        }
        
        html += `
            </div>
            
            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" onclick="analyzeFarm('${farm.id}')">
                    <i class="fas fa-satellite me-2"></i> Run New Analysis
                </button>
                <button class="btn btn-success" onclick="triggerInsuranceCheck('${farm.id}')">
                    <i class="fas fa-file-invoice-dollar me-2"></i> Check Insurance
                </button>
                <button class="btn btn-outline-secondary" onclick="zoomToFarm('${farm.id}')">
                    <i class="fas fa-search-location me-2"></i> Zoom to Farm
                </button>
            </div>
        `;
        
        content.innerHTML = html;
        card.style.display = 'block';
        
        // Scroll to details card
        card.scrollIntoView({ behavior: 'smooth' });
    }
    
    function highlightFarm(farmId) {
        // Reset all markers
        Object.values(farmMarkers).forEach(marker => {
            marker.setZIndexOffset(0);
        });
        
        // Highlight selected farm
        if (farmMarkers[farmId]) {
            farmMarkers[farmId].setZIndexOffset(1000);
            farmMarkers[farmId].openPopup();
            selectedFarms.add(farmId);
        }
    }
    
    function closeFarmDetails() {
        document.getElementById('farm-details-card').style.display = 'none';
        selectedFarms.clear();
        
        // Reset marker highlights
        Object.values(farmMarkers).forEach(marker => {
            marker.setZIndexOffset(0);
        });
    }
    
    function zoomToFarm(farmId) {
        if (farmMarkers[farmId]) {
            const marker = farmMarkers[farmId];
            map.setView(marker.getLatLng(), 14);
            highlightFarm(farmId);
        }
    }
    
    function zoomToMachakos() {
        map.setView([-1.5167, 37.2667], 10);
    }
    
    function toggleSatellite() {
        // This would toggle between map layers
        showToast('Switching to satellite view...', 'info');
    }
    
    function analyzeFarm(farmId) {
        showLoading('Running satellite analysis...');
        
        makeRequest('/farms/api/run-analysis/', 'POST', {
            farm_ids: [farmId],
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1
        }).then(response => {
            hideLoading();
            
            if (response.success) {
                showToast('Analysis completed successfully!', 'success');
                // Refresh farm details
                setTimeout(() => viewFarmDetails(farmId), 1000);
            } else {
                showToast('Analysis failed: ' + response.error, 'danger');
            }
        });
    }
    
    function analyzeSelectedFarms() {
        if (selectedFarms.size === 0) {
            showToast('Please select farms first', 'warning');
            return;
        }
        
        showLoading(`Analyzing ${selectedFarms.size} farms...`);
        
        makeRequest('/farms/api/run-analysis/', 'POST', {
            farm_ids: Array.from(selectedFarms),
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1
        }).then(response => {
            hideLoading();
            
            if (response.success) {
                showToast(`Analysis completed for ${selectedFarms.size} farms`, 'success');
                // Refresh map
                setTimeout(() => loadFarms(), 2000);
            } else {
                showToast('Analysis failed: ' + response.error, 'danger');
            }
        });
    }
    
    function clearSelection() {
        selectedFarms.clear();
        closeFarmDetails();
        showToast('Selection cleared', 'info');
    }
    
    function triggerInsuranceCheck(farmId) {
        showLoading('Checking insurance triggers...');
        
        makeRequest('/farms/api/trigger-insurance/', 'POST', {
            farm_id: farmId
        }).then(response => {
            hideLoading();
            
            if (response.success) {
                if (response.claim_created) {
                    showToast(`Insurance claim created: ${response.claim_number}`, 'success');
                } else {
                    showToast(response.message, 'info');
                }
            } else {
                showToast('Insurance check failed: ' + response.error, 'danger');
            }
        });
    }
    
    function checkGEEStatus() {
        makeRequest('/farms/api/test-gee/').then(response => {
            const statusElement = document.getElementById('gee-status');
            if (response.success) {
                statusElement.className = 'badge bg-success me-2';
                statusElement.textContent = 'GEE: Connected';
            } else {
                statusElement.className = 'badge bg-danger me-2';
                statusElement.textContent = 'GEE: Offline';
            }
        });
    }
    
    function updateFarmCount(count) {
        document.getElementById('farm-count').textContent = `${count} Farms`;
    }
    
    function showFarmChart(farmId) {
        // This would open a modal with charts
        showToast('Opening charts for farm ' + farmId, 'info');
        // Implementation for charts would go here
    }
    
    function exportFarmList() {
        showLoading('Exporting farm list...');
        
        // In a real implementation, this would generate a CSV
        setTimeout(() => {
            hideLoading();
            showToast('Farm list exported successfully', 'success');
        }, 1500);
    }
    
    // Filter functions
    document.getElementById('risk-all').addEventListener('change', applyFilters);
    document.getElementById('risk-low').addEventListener('change', applyFilters);
    document.getElementById('risk-moderate').addEventListener('change', applyFilters);
    document.getElementById('risk-severe').addEventListener('change', applyFilters);
    document.getElementById('crop-filter').addEventListener('change', applyFilters);
    document.getElementById('subcounty-filter').addEventListener('change', applyFilters);
    document.getElementById('area-range').addEventListener('input', function() {
        document.getElementById('area-max').textContent = this.value + '+';
        applyFilters();
    });
    
    function applyFilters() {
        // Get filter values
        const riskFilter = document.querySelector('input[name="risk-filter"]:checked').id.replace('risk-', '');
        const cropFilter = document.getElementById('crop-filter').value;
        const areaMax = document.getElementById('area-range').value;
        
        // Apply filters to markers
        // This would filter the farm markers based on criteria
        showToast('Filters applied', 'info');
    }
    
    // GEE Tile Integration Functions
    function loadNDVILayer(year, month) {
        showLoading('Loading NDVI layer from Google Earth Engine...');
        
        // This is where we would integrate GEE tile URL generation
        // For now, we'll simulate it
        setTimeout(() => {
            hideLoading();
            showToast('NDVI layer loaded for ' + year + '-' + month, 'success');
            
            // In real implementation, we would add a tile layer from GEE
            // Example: L.tileLayer(geeTileUrl).addTo(map);
        }, 2000);
    }
    
    // Toggle NDVI layer
    document.getElementById('toggle-ndvi').addEventListener('change', function() {
        if (this.checked) {
            const currentDate = new Date();
            loadNDVILayer(currentDate.getFullYear(), currentDate.getMonth() + 1);
        } else if (ndviLayer) {
            map.removeLayer(ndviLayer);
            ndviLayer = null;
        }
    });
    
    // Toggle farm markers
    document.getElementById('toggle-farms').addEventListener('change', function() {
        Object.values(farmMarkers).forEach(marker => {
            if (this.checked) {
                map.addLayer(marker);
            } else {
                map.removeLayer(marker);
            }
        });
    });
    
    // Global functions for sidebar
    window.runAnalysis = analyzeSelectedFarms;
    window.exportData = function() {
        showToast('Export feature coming soon!', 'info');
    };
</script>
{% endblock %}