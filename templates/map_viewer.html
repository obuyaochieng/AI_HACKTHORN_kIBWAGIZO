{% extends 'base.html' %}
{% load static %}

{% block title %}Farm Map - Machakos Drought Insurance{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 10px;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid white;
        box-shadow: 0 0 2px rgba(0,0,0,0.3);
    }
    
    .farm-popup {
        min-width: 200px;
    }
    
    .farm-popup h6 {
        color: var(--primary-color);
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Map Header -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="fas fa-map me-2"></i>Farm Map
                </h1>
                <p class="lead mb-0">
                    Interactive map showing all farms with real-time risk assessment
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="btn-group">
                    <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-layer-group me-2"></i>Map Layers
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-layer="satellite">Satellite</a></li>
                        <li><a class="dropdown-item" href="#" data-layer="street">Street Map</a></li>
                        <li><a class="dropdown-item" href="#" data-layer="topo">Topographic</a></li>
                    </ul>
                    <button type="button" class="btn btn-light" id="exportMapBtn">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body p-0 position-relative">
                    <!-- Map Controls -->
                    <div class="map-controls">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Risk Filter:</label>
                            <select id="riskFilter" class="form-select form-select-sm">
                                <option value="all">All Risks</option>
                                <option value="low">Low Risk Only</option>
                                <option value="moderate">Moderate Risk</option>
                                <option value="high">High Risk</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Crop Type:</label>
                            <select id="cropFilter" class="form-select form-select-sm">
                                <option value="all">All Crops</option>
                                <option value="maize">Maize</option>
                                <option value="beans">Beans</option>
                                <option value="wheat">Wheat</option>
                                <option value="vegetables">Vegetables</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showBoundaries">
                            <label class="form-check-label small" for="showBoundaries">
                                Show Boundaries
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showInsurance" checked>
                            <label class="form-check-label small" for="showInsurance">
                                Insurance Triggered
                            </label>
                        </div>
                        <button class="btn btn-sm btn-primary w-100 mt-2" id="locateMeBtn">
                            <i class="fas fa-location-arrow"></i> Locate Me
                        </button>
                    </div>

                    <!-- Map Legend -->
                    <div class="legend">
                        <h6 class="mb-2">Risk Legend</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #28a745;"></div>
                            <span class="small">Low Risk</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffc107;"></div>
                            <span class="small">Moderate Risk</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #dc3545;"></div>
                            <span class="small">High Risk</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6c757d;"></div>
                            <span class="small">No Data</span>
                        </div>
                    </div>

                    <!-- Map Div -->
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farm Statistics -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-primary" id="totalFarms">0</h2>
                    <p class="text-muted mb-0">Total Farms</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-success" id="lowRiskFarms">0</h2>
                    <p class="text-muted mb-0">Low Risk</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-warning" id="moderateRiskFarms">0</h2>
                    <p class="text-muted mb-0">Moderate Risk</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-danger" id="highRiskFarms">0</h2>
                    <p class="text-muted mb-0">High Risk</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Farm List Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Farms on Map
                    </h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search farms..." id="farmSearch">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="farmsTable">
                            <thead>
                                <tr>
                                    <th>Farm ID</th>
                                    <th>Name</th>
                                    <th>Farmer</th>
                                    <th>Crop</th>
                                    <th>Area (ha)</th>
                                    <th>NDVI</th>
                                    <th>Risk Level</th>
                                    <th>Insurance</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="farmsTableBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Parse farm data from Django template
const farmData = JSON.parse('{{ farm_data_json|escapejs }}');
const countyData = JSON.parse('{{ county_data_json|escapejs }}');

let map;
let farmMarkers = [];
let farmBoundaries = [];
let currentLayer = 'street';

$(document).ready(function() {
    // Initialize map
    initMap();
    
    // Initialize farm data table
    initFarmTable();
    
    // Setup event listeners
    setupEventListeners();
});

function initMap() {
    // Create map centered on Machakos
    map = App.Map.initMap('map', {
        center: [{{ map_center_lat|default:"-1.5167" }}, {{ map_center_lng|default:"37.2667" }}],
        zoom: {{ map_default_zoom|default:"10" }},
        minZoom: 8,
        maxZoom: 18
    });
    
    // Add different tile layers
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles Â© Esri'
    });
    
    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    
    const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
    });
    
    // Add county boundaries
    countyData.forEach(county => {
        if (county.geometry_geojson) {
            try {
                const geojson = JSON.parse(county.geometry_geojson);
                L.geoJSON(geojson, {
                    style: {
                        color: '#2c3e50',
                        weight: 2,
                        opacity: 0.5,
                        fillColor: '#3498db',
                        fillOpacity: 0.1
                    }
                }).bindPopup(`
                    <h6>${county.name}</h6>
                    <p class="mb-1 small">Risk: ${county.risk_level}</p>
                    <p class="mb-1 small">Avg Rainfall: ${county.avg_rainfall || 'N/A'} mm</p>
                    <p class="mb-1 small">Farms: ${county.farm_count || 0}</p>
                `).addTo(map);
            } catch (e) {
                console.error('Error parsing county geojson:', e);
            }
        }
    });
    
    // Add farm markers
    addFarmMarkers(farmData);
    
    // Set initial layer
    streetLayer.addTo(map);
    
    // Layer switcher
    $('[data-layer]').click(function(e) {
        e.preventDefault();
        const layer = $(this).data('layer');
        
        // Remove current layer
        map.eachLayer(function(layerObj) {
            if (layerObj._url) {
                map.removeLayer(layerObj);
            }
        });
        
        // Add selected layer
        if (layer === 'satellite') {
            satelliteLayer.addTo(map);
        } else if (layer === 'topo') {
            topoLayer.addTo(map);
        } else {
            streetLayer.addTo(map);
        }
        
        currentLayer = layer;
        
        // Re-add farm markers and boundaries
        addFarmMarkers(farmData);
    });
}

function addFarmMarkers(farms) {
    // Clear existing markers
    farmMarkers.forEach(marker => map.removeLayer(marker));
    farmMarkers = [];
    
    // Clear existing boundaries
    farmBoundaries.forEach(boundary => map.removeLayer(boundary));
    farmBoundaries = [];
    
    let lowRiskCount = 0;
    let moderateRiskCount = 0;
    let highRiskCount = 0;
    
    // Add markers for each farm
    farms.forEach(farm => {
        // Skip if no coordinates
        if (!farm.latitude || !farm.longitude) return;
        
        // Check filters
        const riskFilter = $('#riskFilter').val();
        const cropFilter = $('#cropFilter').val();
        const showInsurance = $('#showInsurance').is(':checked');
        
        if (riskFilter !== 'all' && farm.risk_level !== riskFilter) return;
        if (cropFilter !== 'all' && farm.crop !== cropFilter) return;
        if (showInsurance && !farm.insurance_triggered) return;
        
        // Count by risk level
        if (farm.risk_level === 'low') lowRiskCount++;
        if (farm.risk_level === 'moderate') moderateRiskCount++;
        if (farm.risk_level === 'high') highRiskCount++;
        
        // Create marker
        const marker = App.Map.createFarmMarker(farm, {
            draggable: false
        });
        
        marker.addTo(map);
        farmMarkers.push(marker);
        
        // Add boundary if available and checkbox is checked
        if ($('#showBoundaries').is(':checked') && farm.boundary_coordinates) {
            try {
                const coordinates = JSON.parse(farm.boundary_coordinates);
                const boundary = App.Map.drawFarmBoundary(map, coordinates);
                if (boundary) {
                    farmBoundaries.push(boundary);
                    // Bind popup to boundary as well
                    boundary.bindPopup(`
                        <div class="farm-popup">
                            <h6>${farm.name || farm.farm_id}</h6>
                            <p class="mb-1 small">Farm Boundary</p>
                            <p class="mb-1 small">Area: ${farm.area_ha} ha</p>
                        </div>
                    `);
                }
            } catch (e) {
                console.error('Error parsing boundary coordinates:', e);
            }
        }
        
        // Add click event to zoom to farm
        marker.on('click', function() {
            map.setView([farm.latitude, farm.longitude], 14);
            
            // Highlight farm in table
            $('#farmsTableBody tr').removeClass('table-primary');
            $(`#farm-${farm.id}`).addClass('table-primary');
        });
    });
    
    // Update statistics
    $('#totalFarms').text(farmMarkers.length);
    $('#lowRiskFarms').text(lowRiskCount);
    $('#moderateRiskFarms').text(moderateRiskCount);
    $('#highRiskFarms').text(highRiskCount);
}

function initFarmTable() {
    const tableBody = $('#farmsTableBody');
    tableBody.empty();
    
    farmData.forEach(farm => {
        const row = `
            <tr id="farm-${farm.id}">
                <td>
                    <a href="{% url 'farm_detail' 'PLACEHOLDER' %}".replace('PLACEHOLDER', farm.id) class="text-decoration-none">
                        ${farm.id}
                    </a>
                </td>
                <td>${farm.name || 'Unnamed'}</td>
                <td>${farm.farmer || 'Unknown'}</td>
                <td>${farm.crop || 'Unknown'}</td>
                <td>${farm.area_ha || '0'}</td>
                <td>
                    ${farm.ndvi ? 
                        `<span class="badge bg-${farm.ndvi > 0.6 ? 'success' : farm.ndvi > 0.4 ? 'info' : farm.ndvi > 0.3 ? 'warning' : 'danger'}">
                            ${farm.ndvi.toFixed(3)}
                        </span>` : 
                        'N/A'
                    }
                </td>
                <td>
                    <span class="risk-badge risk-${farm.risk_level}">
                        ${farm.risk_level || 'unknown'}
                    </span>
                </td>
                <td>
                    ${farm.insurance_triggered ? 
                        '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Triggered</span>' : 
                        '<span class="badge bg-success">Normal</span>'
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary zoom-to-farm" data-farm-id="${farm.id}">
                        <i class="fas fa-search-location"></i>
                    </button>
                    <a href="{% url 'farm_detail' 'PLACEHOLDER' %}".replace('PLACEHOLDER', farm.id) 
                       class="btn btn-sm btn-outline-info">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `;
        tableBody.append(row);
    });
    
    // Initialize DataTables
    $('#farmsTable').DataTable({
        pageLength: 10,
        order: [[0, 'desc']],
        language: {
            search: "Search farms:"
        }
    });
}

function setupEventListeners() {
    // Risk filter change
    $('#riskFilter, #cropFilter, #showBoundaries, #showInsurance').change(function() {
        addFarmMarkers(farmData);
    });
    
    // Locate me button
    $('#locateMeBtn').click(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                map.setView([position.coords.latitude, position.coords.longitude], 14);
                L.marker([position.coords.latitude, position.coords.longitude])
                    .addTo(map)
                    .bindPopup('<b>Your Location</b>')
                    .openPopup();
            }, function(error) {
                toastr.error('Unable to get your location: ' + error.message);
            });
        } else {
            toastr.error('Geolocation is not supported by your browser');
        }
    });
    
    // Export map button
    $('#exportMapBtn').click(function() {
        App.showLoading(this);
        setTimeout(() => {
            // In a real implementation, this would generate a PNG of the map
            toastr.success('Map exported successfully!');
            App.hideLoading(this);
        }, 1000);
    });
    
    // Farm search
    $('#farmSearch').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('#farmsTableBody tr').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(searchTerm));
        });
    });
    
    // Zoom to farm from table
    $(document).on('click', '.zoom-to-farm', function() {
        const farmId = $(this).data('farm-id');
        const farm = farmData.find(f => f.id === farmId);
        
        if (farm) {
            map.setView([farm.latitude, farm.longitude], 14);
            
            // Open popup
            farmMarkers.forEach(marker => {
                if (marker.getLatLng().lat === farm.latitude && 
                    marker.getLatLng().lng === farm.longitude) {
                    marker.openPopup();
                }
            });
            
            // Highlight row
            $('#farmsTableBody tr').removeClass('table-primary');
            $(this).closest('tr').addClass('table-primary');
        }
    });
}
</script>
{% endblock %}