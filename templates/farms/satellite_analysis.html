{% extends 'base.html' %}
{% load static %}

{% block title %}Satellite Analysis - Machakos AIDSTTUP{% endblock %}

{% block extra_css %}
<style>
    .analysis-controls {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .index-card {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        color: white;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .index-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .index-card .index-name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .index-card .index-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .index-card .index-description {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .index-card.ndvi { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
    .index-card.evi { background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); }
    .index-card.ndmi { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    .index-card.savi { background: linear-gradient(135deg, #fd7e14 0%, #d2691e 100%); }
    .index-card.ndre { background: linear-gradient(135deg, #6f42c1 0%, #4a2d8c 100%); }
    .index-card.rainfall { background: linear-gradient(135deg, #20c997 0%, #13855c 100%); }
    
    .timeline-container {
        position: relative;
        height: 400px;
    }
    
    .comparison-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .comparison-item {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .comparison-item h5 {
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .threshold-slider {
        width: 100%;
        margin: 15px 0;
    }
    
    .threshold-value {
        display: inline-block;
        padding: 4px 12px;
        background: #f8f9fa;
        border-radius: 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">
            <i class="fas fa-satellite text-primary me-2"></i>
            Satellite Vegetation Analysis
        </h1>
        <p class="text-muted mb-0">
            Analyze farm conditions using Sentinel-2 satellite indices and rainfall data
        </p>
    </div>
</div>

<!-- Analysis Controls -->
<div class="analysis-controls">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Select Year</label>
            <select class="form-select" id="analysis-year">
                {% for year in years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Select Month</label>
            <select class="form-select" id="analysis-month">
                {% for month in months %}
                <option value="{{ month.id }}" {% if month.id == current_month %}selected{% endif %}>{{ month.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Select Index</label>
            <select class="form-select" id="analysis-index">
                {% for index in indices %}
                <option value="{{ index.id }}">{{ index.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Select Farm</label>
            <select class="form-select" id="analysis-farm">
                <option value="all">All Farms (Average)</option>
                <option value="machakos">Machakos County Average</option>
                <option value="specific">Specific Farm...</option>
            </select>
        </div>
        
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <button class="btn btn-primary me-2" onclick="runAnalysis()">
                        <i class="fas fa-play me-2"></i> Run Analysis
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadHistoricalData()">
                        <i class="fas fa-history me-2"></i> Load Historical
                    </button>
                </div>
                <div>
                    <button class="btn btn-success" onclick="exportAnalysis()">
                        <i class="fas fa-download me-2"></i> Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Analysis Results -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-chart-bar me-2"></i>
            Current Analysis Results
            <small class="text-muted" id="current-analysis-period">{{ current_year }}-{{ current_month }}</small>
        </h4>
    </div>
    
    <!-- Index Cards -->
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card ndvi" onclick="showIndexDetails('NDVI')">
            <div class="index-name">NDVI</div>
            <div class="index-value" id="ndvi-value">0.00</div>
            <div class="index-description">Vegetation Health</div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card evi" onclick="showIndexDetails('EVI')">
            <div class="index-name">EVI</div>
            <div class="index-value" id="evi-value">0.00</div>
            <div class="index-description">Enhanced Vegetation</div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card ndmi" onclick="showIndexDetails('NDMI')">
            <div class="index-name">NDMI</div>
            <div class="index-value" id="ndmi-value">0.00</div>
            <div class="index-description">Water Content</div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card savi" onclick="showIndexDetails('SAVI')">
            <div class="index-name">SAVI</div>
            <div class="index-value" id="savi-value">0.00</div>
            <div class="index-description">Soil Adjusted</div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card ndre" onclick="showIndexDetails('NDRE')">
            <div class="index-name">NDRE</div>
            <div class="index-value" id="ndre-value">0.00</div>
            <div class="index-description">Chlorophyll Content</div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="index-card rainfall" onclick="showIndexDetails('rainfall')">
            <div class="index-name">Rainfall</div>
            <div class="index-value" id="rainfall-value">0.0</div>
            <div class="index-description">mm per month</div>
        </div>
    </div>
</div>

<!-- Comparison View -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-balance-scale me-2"></i>
            Comparison View
        </h4>
    </div>
    
    <div class="col-lg-6">
        <div class="comparison-item">
            <h5>Current Period</h5>
            <div id="current-period-chart" class="timeline-container">
                <canvas id="currentChart"></canvas>
            </div>
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <span>Drought Risk:</span>
                    <span class="badge bg-success" id="current-risk">Low</span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span>Insurance Trigger:</span>
                    <span class="badge bg-success" id="current-insurance">Normal</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="comparison-item">
            <h5>Previous Period</h5>
            <div id="previous-period-chart" class="timeline-container">
                <canvas id="previousChart"></canvas>
            </div>
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <span>Drought Risk:</span>
                    <span class="badge bg-warning" id="previous-risk">Moderate</span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span>Insurance Trigger:</span>
                    <span class="badge bg-success" id="previous-insurance">Normal</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Series Analysis -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-chart-line me-2"></i>
        Time Series Analysis
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="timeline-container">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-4">
                    <h6>Analysis Period</h6>
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary active" onclick="setTimeRange('6m')">6M</button>
                        <button class="btn btn-outline-primary" onclick="setTimeRange('1y')">1Y</button>
                        <button class="btn btn-outline-primary" onclick="setTimeRange('3y')">3Y</button>
                        <button class="btn btn-outline-primary" onclick="setTimeRange('5y')">5Y</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>Select Indices</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-ndvi" checked>
                        <label class="form-check-label" for="show-ndvi">NDVI</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-ndmi" checked>
                        <label class="form-check-label" for="show-ndmi">NDMI</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-rainfall">
                        <label class="form-check-label" for="show-rainfall">Rainfall</label>
                    </div>
                </div>
                
                <div>
                    <h6>Trend Analysis</h6>
                    <div class="alert alert-info">
                        <div class="small">Current Trend:</div>
                        <div class="h5" id="trend-indicator">↗ Improving</div>
                        <div class="small text-muted" id="trend-description">Vegetation health improving</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Threshold Configuration -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-sliders-h me-2"></i>
            Drought Threshold Configuration
        </div>
        <button class="btn btn-sm btn-primary" onclick="saveThresholds()">
            <i class="fas fa-save me-1"></i> Save Thresholds
        </button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-4">
                    <label class="form-label">
                        NDVI Threshold for Severe Drought
                        <span class="threshold-value" id="ndvi-severe-value">0.30</span>
                    </label>
                    <input type="range" class="form-range threshold-slider" min="0.1" max="0.5" step="0.01" 
                           value="0.30" id="ndvi-severe-slider">
                    <div class="form-text">
                        Values below this indicate severe vegetation stress
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">
                        NDVI Threshold for Moderate Drought
                        <span class="threshold-value" id="ndvi-moderate-value">0.40</span>
                    </label>
                    <input type="range" class="form-range threshold-slider" min="0.2" max="0.6" step="0.01" 
                           value="0.40" id="ndvi-moderate-slider">
                    <div class="form-text">
                        Values between moderate and severe indicate moderate stress
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-4">
                    <label class="form-label">
                        Rainfall Threshold (mm/month)
                        <span class="threshold-value" id="rainfall-threshold-value">50.0</span>
                    </label>
                    <input type="range" class="form-range threshold-slider" min="10" max="200" step="5" 
                           value="50" id="rainfall-threshold-slider">
                    <div class="form-text">
                        Monthly rainfall below this indicates drought conditions
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">
                        Insurance Payout Rate (KES/ha)
                        <span class="threshold-value" id="payout-rate-value">5000</span>
                    </label>
                    <input type="range" class="form-range threshold-slider" min="1000" max="10000" step="100" 
                           value="5000" id="payout-rate-slider">
                    <div class="form-text">
                        Base insurance payout per hectare for severe drought
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Changing these thresholds will affect all insurance calculations and drought risk assessments.
        </div>
    </div>
</div>

<!-- Index Details Modal -->
<div class="modal fade" id="indexDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="index-modal-title">Index Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="index-details-content">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart instances
    let currentChart, previousChart, timeSeriesChart;
    let currentTimeRange = '1y';
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        setupSliderListeners();
        loadSampleData();
        
        // Set up analysis controls
        document.getElementById('analysis-year').addEventListener('change', updateAnalysisPeriod);
        document.getElementById('analysis-month').addEventListener('change', updateAnalysisPeriod);
        document.getElementById('analysis-index').addEventListener('change', updateCharts);
        
        // Set up index checkboxes
        document.getElementById('show-ndvi').addEventListener('change', updateTimeSeriesChart);
        document.getElementById('show-ndmi').addEventListener('change', updateTimeSeriesChart);
        document.getElementById('show-rainfall').addEventListener('change', updateTimeSeriesChart);
    });
    
    function initCharts() {
        // Current period chart
        const currentCtx = document.getElementById('currentChart').getContext('2d');
        currentChart = new Chart(currentCtx, {
            type: 'bar',
            data: {
                labels: ['NDVI', 'EVI', 'NDMI', 'SAVI', 'NDRE'],
                datasets: [{
                    label: 'Index Values',
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#28a745',
                        '#17a2b8',
                        '#007bff',
                        '#fd7e14',
                        '#6f42c1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Previous period chart
        const previousCtx = document.getElementById('previousChart').getContext('2d');
        previousChart = new Chart(previousCtx, {
            type: 'bar',
            data: {
                labels: ['NDVI', 'EVI', 'NDMI', 'SAVI', 'NDRE'],
                datasets: [{
                    label: 'Index Values',
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: [
                        '#28a745',
                        '#17a2b8',
                        '#007bff',
                        '#fd7e14',
                        '#6f42c1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Time series chart
        const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
        timeSeriesChart = new Chart(timeSeriesCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function setupSliderListeners() {
        // NDVI Severe threshold
        const ndviSevereSlider = document.getElementById('ndvi-severe-slider');
        const ndviSevereValue = document.getElementById('ndvi-severe-value');
        
        ndviSevereSlider.addEventListener('input', function() {
            ndviSevereValue.textContent = parseFloat(this.value).toFixed(2);
        });
        
        // NDVI Moderate threshold
        const ndviModerateSlider = document.getElementById('ndvi-moderate-slider');
        const ndviModerateValue = document.getElementById('ndvi-moderate-value');
        
        ndviModerateSlider.addEventListener('input', function() {
            ndviModerateValue.textContent = parseFloat(this.value).toFixed(2);
        });
        
        // Rainfall threshold
        const rainfallSlider = document.getElementById('rainfall-threshold-slider');
        const rainfallValue = document.getElementById('rainfall-threshold-value');
        
        rainfallSlider.addEventListener('input', function() {
            rainfallValue.textContent = parseFloat(this.value).toFixed(1);
        });
        
        // Payout rate
        const payoutSlider = document.getElementById('payout-rate-slider');
        const payoutValue = document.getElementById('payout-rate-value');
        
        payoutSlider.addEventListener('input', function() {
            payoutValue.textContent = parseInt(this.value).toLocaleString();
        });
    }
    
    function loadSampleData() {
        // Sample data for demonstration
        const sampleData = {
            ndvi: 0.65,
            evi: 0.58,
            ndmi: 0.42,
            savi: 0.61,
            ndre: 0.38,
            rainfall: 78.5,
            risk: 'low',
            insurance: 'normal',
            previous_ndvi: 0.52,
            previous_evi: 0.46,
            previous_ndmi: 0.35,
            previous_savi: 0.48,
            previous_ndre: 0.32,
            previous_rainfall: 42.3,
            previous_risk: 'moderate',
            previous_insurance: 'normal'
        };
        
        // Update index cards
        document.getElementById('ndvi-value').textContent = sampleData.ndvi.toFixed(3);
        document.getElementById('evi-value').textContent = sampleData.evi.toFixed(3);
        document.getElementById('ndmi-value').textContent = sampleData.ndmi.toFixed(3);
        document.getElementById('savi-value').textContent = sampleData.savi.toFixed(3);
        document.getElementById('ndre-value').textContent = sampleData.ndre.toFixed(3);
        document.getElementById('rainfall-value').textContent = sampleData.rainfall.toFixed(1);
        
        // Update risk indicators
        document.getElementById('current-risk').textContent = sampleData.risk.toUpperCase();
        document.getElementById('current-risk').className = `badge bg-${sampleData.risk === 'severe' ? 'danger' : sampleData.risk === 'moderate' ? 'warning' : 'success'}`;
        
        document.getElementById('previous-risk').textContent = sampleData.previous_risk.toUpperCase();
        document.getElementById('previous-risk').className = `badge bg-${sampleData.previous_risk === 'severe' ? 'danger' : sampleData.previous_risk === 'moderate' ? 'warning' : 'success'}`;
        
        // Update insurance indicators
        document.getElementById('current-insurance').textContent = sampleData.insurance.toUpperCase();
        document.getElementById('current-insurance').className = `badge bg-${sampleData.insurance === 'triggered' ? 'danger' : 'success'}`;
        
        document.getElementById('previous-insurance').textContent = sampleData.previous_insurance.toUpperCase();
        document.getElementById('previous-insurance').className = `badge bg-${sampleData.previous_insurance === 'triggered' ? 'danger' : 'success'}`;
        
        // Update charts
        currentChart.data.datasets[0].data = [
            sampleData.ndvi,
            sampleData.evi,
            sampleData.ndmi,
            sampleData.savi,
            sampleData.ndre
        ];
        currentChart.update();
        
        previousChart.data.datasets[0].data = [
            sampleData.previous_ndvi,
            sampleData.previous_evi,
            sampleData.previous_ndmi,
            sampleData.previous_savi,
            sampleData.previous_ndre
        ];
        previousChart.update();
        
        // Load time series data
        loadTimeSeriesData();
    }
    
    function loadTimeSeriesData() {
        // Generate sample time series data
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const ndviData = Array.from({length: 12}, () => Math.random() * 0.4 + 0.3);
        const ndmiData = Array.from({length: 12}, () => Math.random() * 0.3 + 0.2);
        const rainfallData = Array.from({length: 12}, () => Math.random() * 100 + 30);
        
        timeSeriesChart.data.labels = months;
        timeSeriesChart.data.datasets = [
            {
                label: 'NDVI',
                data: ndviData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            },
            {
                label: 'NDMI',
                data: ndmiData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            },
            {
                label: 'Rainfall (mm)',
                data: rainfallData,
                borderColor: '#20c997',
                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }
        ];
        
        timeSeriesChart.options.scales = {
            y: {
                beginAtZero: true,
                max: 1,
                title: {
                    display: true,
                    text: 'Index Value'
                }
            },
            y1: {
                position: 'right',
                beginAtZero: true,
                max: 200,
                title: {
                    display: true,
                    text: 'Rainfall (mm)'
                },
                grid: {
                    drawOnChartArea: false
                }
            }
        };
        
        timeSeriesChart.update();
        
        // Update trend indicator
        const lastNdvi = ndviData[ndviData.length - 1];
        const firstNdvi = ndviData[0];
        const trend = lastNdvi - firstNdvi;
        
        const trendIndicator = document.getElementById('trend-indicator');
        const trendDescription = document.getElementById('trend-description');
        
        if (trend > 0.1) {
            trendIndicator.textContent = '↗ Improving';
            trendIndicator.style.color = '#28a745';
            trendDescription.textContent = 'Vegetation health showing significant improvement';
        } else if (trend > 0) {
            trendIndicator.textContent = '↗ Slightly Improving';
            trendIndicator.style.color = '#28a745';
            trendDescription.textContent = 'Vegetation health improving gradually';
        } else if (trend > -0.1) {
            trendIndicator.textContent = '↘ Slightly Declining';
            trendIndicator.style.color = '#ffc107';
            trendDescription.textContent = 'Vegetation health showing minor decline';
        } else {
            trendIndicator.textContent = '↘ Declining';
            trendIndicator.style.color = '#dc3545';
            trendDescription.textContent = 'Vegetation health declining significantly';
        }
    }
    
    function updateAnalysisPeriod() {
        const year = document.getElementById('analysis-year').value;
        const month = document.getElementById('analysis-month').value;
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        document.getElementById('current-analysis-period').textContent = 
            `${year}-${month} (${monthNames[month - 1]})`;
    }
    
    function updateCharts() {
        const selectedIndex = document.getElementById('analysis-index').value;
        
        // In real implementation, this would fetch new data for the selected index
        showToast(`Loading ${selectedIndex} data...`, 'info');
    }
    
    function updateTimeSeriesChart() {
        const showNdvi = document.getElementById('show-ndvi').checked;
        const showNdmi = document.getElementById('show-ndmi').checked;
        const showRainfall = document.getElementById('show-rainfall').checked;
        
        // Update visibility of datasets
        timeSeriesChart.data.datasets.forEach((dataset, index) => {
            if (dataset.label === 'NDVI') {
                dataset.hidden = !showNdvi;
            } else if (dataset.label === 'NDMI') {
                dataset.hidden = !showNdmi;
            } else if (dataset.label === 'Rainfall (mm)') {
                dataset.hidden = !showRainfall;
            }
        });
        
        timeSeriesChart.update();
    }
    
    function setTimeRange(range) {
        currentTimeRange = range;
        
        // Update button states
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // In real implementation, this would fetch data for the selected range
        showToast(`Loading ${range} time series data...`, 'info');
        
        // Update chart with new data range
        setTimeout(() => {
            loadTimeSeriesData();
        }, 500);
    }
    
    // Main analysis functions
    function runAnalysis() {
        const year = document.getElementById('analysis-year').value;
        const month = document.getElementById('analysis-month').value;
        const index = document.getElementById('analysis-index').value;
        const farm = document.getElementById('analysis-farm').value;
        
        showLoading(`Running ${index} analysis for ${year}-${month}...`);
        
        // In real implementation, this would call the GEE API
        setTimeout(() => {
            hideLoading();
            showToast(`Analysis completed for ${index}`, 'success');
            
            // Update with simulated results
            const newData = {
                ndvi: Math.random() * 0.5 + 0.3,
                evi: Math.random() * 0.4 + 0.2,
                ndmi: Math.random() * 0.3 + 0.2,
                savi: Math.random() * 0.5 + 0.3,
                ndre: Math.random() * 0.2 + 0.1,
                rainfall: Math.random() * 100 + 30
            };
            
            document.getElementById('ndvi-value').textContent = newData.ndvi.toFixed(3);
            document.getElementById('evi-value').textContent = newData.evi.toFixed(3);
            document.getElementById('ndmi-value').textContent = newData.ndmi.toFixed(3);
            document.getElementById('savi-value').textContent = newData.savi.toFixed(3);
            document.getElementById('ndre-value').textContent = newData.ndre.toFixed(3);
            document.getElementById('rainfall-value').textContent = newData.rainfall.toFixed(1);
            
            // Update current chart
            currentChart.data.datasets[0].data = [
                newData.ndvi,
                newData.evi,
                newData.ndmi,
                newData.savi,
                newData.ndre
            ];
            currentChart.update();
        }, 2000);
    }
    
    function loadHistoricalData() {
        showLoading('Loading historical analysis data...');
        
        // In real implementation, this would fetch historical data
        setTimeout(() => {
            hideLoading();
            showToast('Historical data loaded successfully', 'success');
            loadTimeSeriesData();
        }, 1500);
    }
    
    function exportAnalysis() {
        showLoading('Preparing analysis data for export...');
        
        // In real implementation, this would generate CSV/Excel files
        setTimeout(() => {
            hideLoading();
            showToast('Analysis data exported successfully', 'success');
            
            // Simulate download
            const link = document.createElement('a');
            link.href = '#';
            link.download = `analysis_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, 2000);
    }
    
    function showIndexDetails(indexName) {
        const modalTitle = document.getElementById('index-modal-title');
        const modalContent = document.getElementById('index-details-content');
        
        const indexDetails = {
            'NDVI': {
                title: 'Normalized Difference Vegetation Index (NDVI)',
                description: 'NDVI quantifies vegetation by measuring the difference between near-infrared (which vegetation strongly reflects) and red light (which vegetation absorbs).',
                formula: 'NDVI = (NIR - Red) / (NIR + Red)',
                range: 'Values range from -1 to 1. Healthy vegetation: 0.3 to 0.8',
                interpretation: 'Higher values indicate healthier, denser vegetation. Lower values indicate stressed or sparse vegetation.',
                useCase: 'Primary indicator for drought monitoring in maize crops.'
            },
            'EVI': {
                title: 'Enhanced Vegetation Index (EVI)',
                description: 'EVI improves on NDVI by correcting for atmospheric conditions and soil background noise.',
                formula: 'EVI = 2.5 * ((NIR - Red) / (NIR + 6*Red - 7.5*Blue + 1))',
                range: 'Values typically range from -1 to 1',
                interpretation: 'More sensitive than NDVI in regions with high biomass. Less affected by atmospheric conditions.',
                useCase: 'Useful in areas with dense vegetation or hazy conditions.'
            },
            'NDMI': {
                title: 'Normalized Difference Moisture Index (NDMI)',
                description: 'NDMI is sensitive to the water content in vegetation canopies.',
                formula: 'NDMI = (NIR - SWIR) / (NIR + SWIR)',
                range: 'Values range from -1 to 1',
                interpretation: 'Higher values indicate higher water content in vegetation. Useful for detecting water stress before visible symptoms appear.',
                useCase: 'Early detection of drought stress in crops.'
            },
            'SAVI': {
                title: 'Soil Adjusted Vegetation Index (SAVI)',
                description: 'SAVI minimizes soil brightness influences for vegetation with incomplete canopy cover.',
                formula: 'SAVI = ((NIR - Red) / (NIR + Red + L)) * (1 + L)',
                range: 'Values typically 0.1 to 0.7 for vegetation',
                interpretation: 'Where L is a soil adjustment factor (typically 0.5). Better than NDVI for sparse vegetation.',
                useCase: 'Ideal for early growth stages of maize when canopy is not complete.'
            },
            'NDRE': {
                title: 'Normalized Difference Red Edge (NDRE)',
                description: 'NDRE uses the red edge band which is sensitive to chlorophyll content in leaves.',
                formula: 'NDRE = (NIR - Red Edge) / (NIR + Red Edge)',
                range: 'Values typically 0.1 to 0.45 for healthy crops',
                interpretation: 'Sensitive to chlorophyll content and nitrogen status. Good indicator of crop health and maturity.',
                useCase: 'Monitoring maize growth stages and nutrient status.'
            },
            'rainfall': {
                title: 'Rainfall Data (CHIRPS)',
                description: 'Climate Hazards group InfraRed Precipitation with Station data provides high-resolution rainfall estimates.',
                source: 'University of California Santa Barbara Climate Hazards Center',
                resolution: '0.05° (~5km) daily rainfall estimates',
                useCase: 'Monitoring rainfall deficits and drought conditions.',
                interpretation: 'Values below 50mm/month indicate drought conditions for maize in Machakos County.'
            }
        };
        
        const details = indexDetails[indexName] || indexDetails['NDVI'];
        
        modalTitle.textContent = details.title;
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <p>${details.description}</p>
                    
                    ${details.formula ? `
                    <div class="alert alert-light border">
                        <strong>Formula:</strong> ${details.formula}
                    </div>
                    ` : ''}
                    
                    <h6>Interpretation</h6>
                    <p>${details.interpretation}</p>
                    
                    <h6>Use Case in Machakos</h6>
                    <p>${details.useCase}</p>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Threshold Guidelines</div>
                        <div class="card-body">
                            ${details.range ? `<p><strong>Typical Range:</strong> ${details.range}</p>` : ''}
                            ${details.source ? `<p><strong>Data Source:</strong> ${details.source}</p>` : ''}
                            ${details.resolution ? `<p><strong>Spatial Resolution:</strong> ${details.resolution}</p>` : ''}
                            
                            <hr>
                            
                            <h6>Drought Indicators</h6>
                            <ul class="small">
                                <li><span class="text-success">●</span> Normal: Above threshold</li>
                                <li><span class="text-warning">●</span> Moderate: Approaching threshold</li>
                                <li><span class="text-danger">●</span> Severe: Below threshold</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('indexDetailsModal'));
        modal.show();
    }
    
    function saveThresholds() {
        const thresholds = {
            ndvi_severe: parseFloat(document.getElementById('ndvi-severe-slider').value),
            ndvi_moderate: parseFloat(document.getElementById('ndvi-moderate-slider').value),
            rainfall_threshold: parseFloat(document.getElementById('rainfall-threshold-slider').value),
            payout_rate: parseInt(document.getElementById('payout-rate-slider').value)
        };
        
        showLoading('Saving threshold configuration...');
        
        // In real implementation, this would save to server
        setTimeout(() => {
            hideLoading();
            showToast('Threshold configuration saved successfully', 'success');
            
            // Update system with new thresholds
            updateSystemThresholds(thresholds);
        }, 1500);
    }
    
    function updateSystemThresholds(thresholds) {
        // This would update the system with new thresholds
        console.log('Updating system thresholds:', thresholds);
        
        // Update any real-time displays or calculations
        showToast('System updated with new thresholds', 'info');
    }
</script>
{% endblock %}