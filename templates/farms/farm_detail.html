{% extends 'base.html' %}

{% block title %}{{ farm.farm_id }} - Farm Details{% endblock %}

{% block extra_css %}
<style>
    .farm-stats-card {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        color: white;
    }
    
    .farm-stats-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .farm-stats-card .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .timeline-chart {
        height: 300px;
    }
    
    .farm-map {
        height: 400px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Farm Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-tractor text-primary me-2"></i>
                        {{ farm.name|default:"Unnamed Farm" }}
                    </h1>
                    <p class="text-muted mb-0">
                        Farm ID: {{ farm.farm_id }} | 
                        Registered: {{ farm.registration_date|date:"Y-m-d" }}
                    </p>
                </div>
                <div class="btn-group">
                    <a href="{% url 'map_viewer' %}?farm={{ farm.farm_id }}" class="btn btn-outline-primary">
                        <i class="fas fa-map-marked-alt me-2"></i> View on Map
                    </a>
                    <a href="{% url 'admin:farms_farm_change' farm.id %}" class="btn btn-outline-warning" target="_blank">
                        <i class="fas fa-edit me-2"></i> Edit Farm
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Farm Statistics -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="stat-value">{{ farm.area_ha|floatformat:2 }}</div>
                <div class="stat-label">Hectares</div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="stat-value">{{ farm.crop_type|title }}</div>
                <div class="stat-label">Crop Type</div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="stat-value">
                    {% if farm.irrigation %}
                    <i class="fas fa-check"></i>
                    {% else %}
                    <i class="fas fa-times"></i>
                    {% endif %}
                </div>
                <div class="stat-label">Irrigation</div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="stat-value">
                    {% if latest_analysis %}
                    {{ latest_analysis.ndvi|floatformat:3|default:"N/A" }}
                    {% else %}
                    N/A
                    {% endif %}
                </div>
                <div class="stat-label">Current NDVI</div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="stat-value">
                    {% if latest_analysis %}
                    {{ latest_analysis.drought_risk_level|title }}
                    {% else %}
                    Unknown
                    {% endif %}
                </div>
                <div class="stat-label">Risk Level</div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6">
            <div class="farm-stats-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                <div class="stat-value">
                    {% if insurance_policy %}
                    Active
                    {% else %}
                    None
                    {% endif %}
                </div>
                <div class="stat-label">Insurance</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column: Farm Details -->
        <div class="col-lg-8">
            <!-- Farm Map -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-map me-2"></i>
                    Farm Location
                </div>
                <div class="card-body p-0">
                    <div id="farm-map" class="farm-map"></div>
                </div>
            </div>
            
            <!-- Analysis History -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-chart-line me-2"></i>
                        Analysis History
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="runFarmAnalysis()">
                        <i class="fas fa-play me-1"></i> Run New Analysis
                    </button>
                </div>
                <div class="card-body">
                    {% if analyses %}
                    <div class="timeline-chart">
                        <canvas id="analysisChart"></canvas>
                    </div>
                    
                    <div class="table-responsive mt-4">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>NDVI</th>
                                    <th>NDMI</th>
                                    <th>SAVI</th>
                                    <th>Rainfall</th>
                                    <th>Risk Level</th>
                                    <th>Insurance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in analyses %}
                                <tr>
                                    <td>{{ analysis.analysis_date|date:"Y-m-d" }}</td>
                                    <td>{{ analysis.ndvi|floatformat:3|default:"N/A" }}</td>
                                    <td>{{ analysis.ndmi|floatformat:3|default:"N/A" }}</td>
                                    <td>{{ analysis.savi|floatformat:3|default:"N/A" }}</td>
                                    <td>{{ analysis.rainfall_mm|floatformat:1|default:"N/A" }} mm</td>
                                    <td>
                                        <span class="badge {% if analysis.drought_risk_level == 'severe' %}bg-danger{% elif analysis.drought_risk_level == 'moderate' %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ analysis.drought_risk_level|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if analysis.insurance_triggered %}
                                        <span class="badge bg-danger">Triggered</span>
                                        {% else %}
                                        <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5>No Analysis Data</h5>
                        <p class="text-muted">This farm hasn't been analyzed yet.</p>
                        <button class="btn btn-primary" onclick="runFarmAnalysis()">
                            <i class="fas fa-satellite me-2"></i> Run First Analysis
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column: Farm Info & Actions -->
        <div class="col-lg-4">
            <!-- Farmer Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-user me-2"></i>
                    Farmer Information
                </div>
                <div class="card-body">
                    {% if farm.farmer %}
                    <div class="text-center mb-3">
                        <div class="display-4">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h5 class="mt-2">{{ farm.farmer.full_name }}</h5>
                    </div>
                    
                    <table class="table table-sm">
                        <tr>
                            <td><strong>National ID:</strong></td>
                            <td>{{ farm.farmer.national_id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Phone:</strong></td>
                            <td>{{ farm.farmer.phone_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>Gender:</strong></td>
                            <td>{{ farm.farmer.get_gender_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>Village:</strong></td>
                            <td>{{ farm.farmer.village }}</td>
                        </tr>
                        <tr>
                            <td><strong>Subcounty:</strong></td>
                            <td>{{ farm.farmer.subcounty.subcounty|default:"Unknown" }}</td>
                        </tr>
                    </table>
                    
                    <div class="mt-3">
                        <a href="{% url 'admin:farms_farmer_change' farm.farmer.id %}" class="btn btn-sm btn-outline-primary w-100" target="_blank">
                            <i class="fas fa-edit me-2"></i> Edit Farmer Details
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-user-slash fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No farmer assigned to this farm</p>
                        <a href="{% url 'admin:farms_farm_change' farm.id %}" class="btn btn-sm btn-primary" target="_blank">
                            <i class="fas fa-link me-2"></i> Assign Farmer
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Farm Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>
                    Farm Details
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Farm ID:</strong></td>
                            <td>{{ farm.farm_id }}</td>
                        </tr>
                        <tr>
                            <td><strong>OSM ID:</strong></td>
                            <td>{{ farm.osm_id|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Crop Variety:</strong></td>
                            <td>{{ farm.crop_variety|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Planting Date:</strong></td>
                            <td>{{ farm.planting_date|date:"Y-m-d"|default:"Not set" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Harvest Date:</strong></td>
                            <td>{{ farm.expected_harvest_date|date:"Y-m-d"|default:"Not set" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Soil Quality:</strong></td>
                            <td>{{ farm.get_soil_quality_display|default:"Unknown" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Irrigation Type:</strong></td>
                            <td>{{ farm.get_irrigation_type_display|default:"None" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Operator:</strong></td>
                            <td>{{ farm.operator|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cooperative:</strong></td>
                            <td>{{ farm.cooperative|default:"N/A" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="runFarmAnalysis()">
                            <i class="fas fa-satellite me-2"></i>
                            Run Satellite Analysis
                        </button>
                        
                        <button class="btn btn-success" onclick="checkInsurance()">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            Check Insurance Trigger
                        </button>
                        
                        {% if insurance_policy %}
                        <button class="btn btn-warning" onclick="viewInsurance()">
                            <i class="fas fa-file-contract me-2"></i>
                            View Insurance Policy
                        </button>
                        {% else %}
                        <a href="{% url 'admin:insurance_insurancepolicy_add' %}?farm={{ farm.id }}" class="btn btn-warning" target="_blank">
                            <i class="fas fa-plus-circle me-2"></i>
                            Create Insurance Policy
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'satellite_analysis' %}?farm={{ farm.farm_id }}" class="btn btn-info">
                            <i class="fas fa-chart-bar me-2"></i>
                            Advanced Analysis
                        </a>
                        
                        <button class="btn btn-outline-danger" onclick="exportFarmData()">
                            <i class="fas fa-download me-2"></i>
                            Export Farm Data
                        </button>
                    </div>
                    
                    {% if claims %}
                    <hr>
                    <h6 class="mb-3">Recent Claims</h6>
                    <div class="list-group list-group-flush">
                        {% for claim in claims %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <strong>{{ claim.claim_number }}</strong>
                                <span class="badge {% if claim.status == 'approved' %}bg-success{% elif claim.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ claim.status|title }}
                                </span>
                            </div>
                            <small class="text-muted">{{ claim.trigger_date|date:"Y-m-d" }} • KES {{ claim.claim_amount|floatformat:2 }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let farmMap;
    let analysisChart;
    
    document.addEventListener('DOMContentLoaded', function() {
        initFarmMap();
        initAnalysisChart();
    });
    
    function initFarmMap() {
        // Initialize map centered on farm
        const centroid = {
            lat: {{ farm.centroid.y|default:"-1.5167" }},
            lng: {{ farm.centroid.x|default:"37.2667" }}
        };
        
        farmMap = L.map('farm-map').setView([centroid.lat, centroid.lng], 14);
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(farmMap);
        
        // Add farm boundary (if available)
        // Note: In production, you would load the actual farm geometry
        
        // Add marker for farm centroid
        L.marker([centroid.lat, centroid.lng], {
            icon: L.divIcon({
                className: 'farm-marker-icon',
                html: '<div class="farm-marker" style="background-color: #28a745;">F</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(farmMap)
        .bindPopup('<strong>{{ farm.name|default:"Farm" }}</strong><br>{{ farm.farm_id }}');
        
        // Add scale
        L.control.scale().addTo(farmMap);
    }
    
    function initAnalysisChart() {
        const ctx = document.getElementById('analysisChart').getContext('2d');
        
        {% if analyses %}
        const dates = [
            {% for analysis in analyses reversed %}
            '{{ analysis.analysis_date|date:"M Y" }}',
            {% endfor %}
        ];
        
        const ndviData = [
            {% for analysis in analyses reversed %}
            {{ analysis.ndvi|default:"null" }},
            {% endfor %}
        ];
        
        const rainfallData = [
            {% for analysis in analyses reversed %}
            {{ analysis.rainfall_mm|default:"null" }},
            {% endfor %}
        ];
        
        analysisChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'NDVI',
                        data: ndviData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Rainfall (mm)',
                        data: rainfallData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 1,
                        title: {
                            display: true,
                            text: 'NDVI'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        title: {
                            display: true,
                            text: 'Rainfall (mm)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.dataset.label === 'NDVI' 
                                        ? context.parsed.y.toFixed(3)
                                        : context.parsed.y.toFixed(1) + ' mm';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
    }
    
    function runFarmAnalysis() {
        showLoading('Running satellite analysis...');
        
        fetch('/farms/api/run-analysis/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                farm_ids: ['{{ farm.farm_id }}'],
                year: new Date().getFullYear(),
                month: new Date().getMonth() + 1
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('Analysis completed successfully!', 'success');
                // Refresh page after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast('Analysis failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Error: ' + error.message, 'danger');
        });
    }
    
    function checkInsurance() {
        showLoading('Checking insurance trigger...');
        
        fetch('/farms/api/trigger-insurance/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                farm_id: '{{ farm.farm_id }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                if (data.claim_created) {
                    showToast('Insurance claim created: ' + data.claim_number, 'success');
                } else {
                    showToast(data.message, 'info');
                }
            } else {
                showToast('Insurance check failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Error: ' + error.message, 'danger');
        });
    }
    
    function viewInsurance() {
        {% if insurance_policy %}
        window.open('/admin/insurance/insurancepolicy/{{ insurance_policy.id }}/change/', '_blank');
        {% endif %}
    }
    
    function exportFarmData() {
        showLoading('Exporting farm data...');
        
        // In real implementation, this would generate a report
        setTimeout(() => {
            hideLoading();
            showToast('Farm data exported successfully', 'success');
            
            // Simulate download
            const link = document.createElement('a');
            link.href = '#';
            link.download = 'farm_{{ farm.farm_id }}_data_' + new Date().toISOString().split('T')[0] + '.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, 1500);
    }
</script>
{% endblock %}