{% extends 'base.html' %}

{% block title %}Dashboard - Machakos Drought Monitoring{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Banner -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h1 class="card-title">
                                <i class="fas fa-tractor"></i> Welcome, {{ user.get_full_name|default:user.username }}!
                            </h1>
                            <p class="card-text">
                                {% if user.is_farmer %}
                                Monitor your farms, track vegetation health, and manage your insurance policies.
                                {% else %}
                                Monitor farm health, manage insurance policies, and analyze drought risks.
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <p class="mb-0"><strong>Today:</strong> {{ today|date:"F d, Y" }}</p>
                            <p class="mb-0"><strong>Role:</strong> {{ user.get_user_type_display }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="row mb-4">
        {% if user.is_farmer %}
        <!-- Farmer Stats -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">My Farms</h6>
                            <h2 class="mb-0">{{ farm_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-map-marker-alt fa-3x text-success"></i>
                        </div>
                    </div>
                    <a href="{% url 'farm_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Active Policies</h6>
                            <h2 class="mb-0">{{ active_policies }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shield-alt fa-3x text-info"></i>
                        </div>
                    </div>
                    <a href="{% url 'policy_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Pending Claims</h6>
                            <h2 class="mb-0">{{ pending_claims }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-invoice-dollar fa-3x text-warning"></i>
                        </div>
                    </div>
                    <a href="{% url 'claim_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">High Risk Farms</h6>
                            <h2 class="mb-0">{{ risk_summary.high|default:0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- Admin Stats -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Total Farms</h6>
                            <h2 class="mb-0">{{ total_farms }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-map-marker-alt fa-3x text-primary"></i>
                        </div>
                    </div>
                    <a href="{% url 'farm_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Active Policies</h6>
                            <h2 class="mb-0">{{ active_policies }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shield-alt fa-3x text-success"></i>
                        </div>
                    </div>
                    <a href="{% url 'policy_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Pending Claims</h6>
                            <h2 class="mb-0">{{ pending_claims }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-invoice-dollar fa-3x text-warning"></i>
                        </div>
                    </div>
                    <a href="{% url 'claim_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted">Total Payout</h6>
                            <h2 class="mb-0">KES {{ total_payout|floatformat:0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-money-bill-wave fa-3x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Main Content -->
    <div class="row">
        {% if user.is_farmer %}
        <!-- Farmer Dashboard -->
        <div class="col-md-8 mb-4">
            <!-- Recent Analysis -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-satellite"></i> Recent Farm Analysis
                        <a href="{% url 'satellite_analysis' %}" class="btn btn-sm btn-primary float-end">
                            <i class="fas fa-plus"></i> New Analysis
                        </a>
                    </h5>
                </div>
                <div class="card-body">
                    {% if latest_analyses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Farm</th>
                                    <th>Date</th>
                                    <th>NDVI</th>
                                    <th>Rainfall</th>
                                    <th>Risk</th>
                                    <th>Insurance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in latest_analyses %}
                                <tr>
                                    <td>
                                        <a href="{% url 'farm_detail' farm_id=analysis.farm.farm_id %}">
                                            {{ analysis.farm.name|default:analysis.farm.farm_id }}
                                        </a>
                                    </td>
                                    <td>{{ analysis.year }}-{{ analysis.month|stringformat:"02d" }}</td>
                                    <td>
                                        {% if analysis.ndvi %}
                                        <span class="badge {% if analysis.ndvi > 0.6 %}bg-success{% elif analysis.ndvi > 0.4 %}bg-info{% elif analysis.ndvi > 0.3 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ analysis.ndvi|floatformat:3 }}
                                        </span>
                                        {% else %}N/A{% endif %}
                                    </td>
                                    <td>
                                        {% if analysis.rainfall_mm %}
                                        {{ analysis.rainfall_mm|floatformat:1 }} mm
                                        {% else %}N/A{% endif %}
                                    </td>
                                    <td>
                                        <span class="risk-badge risk-{{ analysis.drought_risk_level }}">
                                            {{ analysis.drought_risk_level|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if analysis.insurance_triggered %}
                                        <span class="badge bg-danger">Triggered</span>
                                        {% else %}
                                        <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-satellite fa-4x text-muted mb-3"></i>
                        <h5>No Analysis Data</h5>
                        <p class="text-muted">Run your first analysis to see data here.</p>
                        <a href="{% url 'satellite_analysis' %}" class="btn btn-primary">
                            <i class="fas fa-play"></i> Run Analysis
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-plus-circle fa-3x text-primary mb-3"></i>
                            <h5>Add New Farm</h5>
                            <p class="text-muted">Register a new farm for monitoring</p>
                            <a href="{% url 'farm_add' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Farm
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                            <h5>Get Insurance</h5>
                            <p class="text-muted">Apply for drought insurance coverage</p>
                            <a href="{% url 'policy_add' %}" class="btn btn-success">
                                <i class="fas fa-file-signature"></i> Apply Now
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <!-- Notifications -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bell"></i> Notifications
                        <a href="{% url 'notifications' %}" class="btn btn-sm btn-outline-primary float-end">
                            View All
                        </a>
                    </h5>
                </div>
                <div class="card-body">
                    {% if notifications %}
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                        <div class="list-group-item {% if not notification.is_read %}bg-light{% endif %}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ notification.title }}</h6>
                                <small>{{ notification.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1 small">{{ notification.message|truncatechars:100 }}</p>
                            {% if not notification.is_read %}
                            <a href="{% url 'mark_notification_read' notification.id %}" class="btn btn-sm btn-outline-success btn-sm">
                                Mark Read
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                        <h5>All Caught Up!</h5>
                        <p class="text-muted">No new notifications.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Risk Overview -->
            {% if risk_summary %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Risk Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="riskChart" height="200"></canvas>
                    <script>
                    var ctx = document.getElementById('riskChart').getContext('2d');
                    var riskChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Low Risk', 'Moderate Risk', 'High Risk'],
                            datasets: [{
                                data: [
                                    {{ risk_summary.low|default:0 }},
                                    {{ risk_summary.moderate|default:0 }},
                                    {{ risk_summary.high|default:0 }}
                                ],
                                backgroundColor: [
                                    '#28a745',
                                    '#ffc107',
                                    '#dc3545'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                }
                            }
                        }
                    });
                    </script>
                </div>
            </div>
            {% endif %}
        </div>
        
        {% else %}
        <!-- Admin Dashboard -->
        <div class="col-md-8 mb-4">
            <!-- Recent Claims -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar"></i> Recent Claims
                        <a href="{% url 'claim_list' %}" class="btn btn-sm btn-primary float-end">
                            View All
                        </a>
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_claims %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Claim #</th>
                                    <th>Farm</th>
                                    <th>Policy</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Submitted</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for claim in recent_claims %}
                                <tr>
                                    <td>
                                        <a href="{% url 'claim_detail' pk=claim.id %}">
                                            {{ claim.claim_number }}
                                        </a>
                                    </td>
                                    <td>{{ claim.farm.farm_id }}</td>
                                    <td>{{ claim.policy.policy_number }}</td>
                                    <td>KES {{ claim.claimed_amount|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge bg-{{ claim.status_color }}">
                                            {{ claim.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ claim.submitted_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if claim.status == 'submitted' %}
                                        <a href="{% url 'claim_approve' pk=claim.id %}" class="btn btn-sm btn-success">
                                            Review
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                        <h5>No Recent Claims</h5>
                        <p class="text-muted">No claims have been submitted recently.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- System Alerts -->
            {% if system_alerts %}
            <div class="card mt-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> System Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for alert in system_alerts %}
                        <div class="list-group-item list-group-item-warning">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ alert.title }}</h6>
                                <small>{{ alert.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ alert.message }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4 mb-4">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'batch_analysis' %}" class="btn btn-primary">
                            <i class="fas fa-satellite"></i> Run Batch Analysis
                        </a>
                        <a href="{% url 'policy_add' %}" class="btn btn-success">
                            <i class="fas fa-file-signature"></i> Create Policy
                        </a>
                        <a href="{% url 'farm_add' %}" class="btn btn-info">
                            <i class="fas fa-plus"></i> Add Farm
                        </a>
                        <a href="{% url 'test_gee' %}" class="btn btn-warning">
                            <i class="fas fa-plug"></i> Test GEE Connection
                        </a>
                        <a href="/admin/" class="btn btn-dark">
                            <i class="fas fa-cog"></i> Django Admin
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Risk Distribution -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Risk Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h2 class="text-success">{{ risk_counts.low|default:0 }}</h2>
                            <small class="text-muted">Low Risk</small>
                        </div>
                        <div class="col-4">
                            <h2 class="text-warning">{{ risk_counts.moderate|default:0 }}</h2>
                            <small class="text-muted">Moderate</small>
                        </div>
                        <div class="col-4">
                            <h2 class="text-danger">{{ risk_counts.severe|default:0 }}</h2>
                            <small class="text-muted">High Risk</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Recent Activity -->
    {% if recent_activity %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Today's Activity</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        {% for key, value in recent_activity.items %}
                        <div class="col-md-3 col-6 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary">{{ value }}</h3>
                                <small class="text-muted text-uppercase">{{ key|title }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}